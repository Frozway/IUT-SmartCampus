{% extends 'base.html.twig' %}

{% block title %}Admin Dashboard{% endblock %}

{% block body %}
    <link rel="stylesheet" href="{{ asset('css/styles.css') }}">
    <link rel="stylesheet" href="{{ asset('css/adminDashboard.css') }}">
    

    <div class="page-wrapper d-inline-flex">

        <div class="sidebar">
            <div>
                <img src="{{ asset('images/logo.png') }}" alt="Logo"/>
            </div>
            <div class="align-self-baseline d-flex justify-content-center w-100">
                <a href="{{ path('app_logout') }}" class="btn" style="color: white"><i class="fa-solid fa-right-from-bracket fa-xl"></i></a>
            </div>
        </div>

        <div class="content" style="flex-grow: 1;">

        <h2><i class="fa-solid fa-house"></i> Tableau de bord</h2>

        {# Alertes #}
        <div class="flex">
            <div class="panel shadow">
                <span class="fs-5">Alertes</span>
                <div class="row px-2 mt-2">
                    {% if alerts is defined %}
                    {% for alert in alerts %}
                    <div class="alerte mt-2 mx-1 p-0 border-0 {{ alert.category == 'red' ? 'alert-red' :'alert-orange' }}">
                        <div class="icon-container p-2 d-inline-flex">
                            {% if alert.type == 'co2' %}
                                <img src="{{ asset('images/icon_carbon.png') }}" alt="" class="img-fluid">
                            {% endif %}

                            {% if alert.type == 'temperature' %}
                                <img src="{{ asset('images/icon_temperature.png') }}" alt="" class="img-fluid">
                            {% endif %}

                            {% if alert.type == 'humidity' %}
                                <img src="{{ asset('images/icon_humidity.png') }}" alt="" class="img-fluid">
                            {% endif %}
                        </div>
                        <div class="room-name">
                            <p style="font-size: 12pt; font-weight: 500;">{{ alert.room }}</p>
                            <p style="font-weight: 800;">{{ alert.value }}</p>    
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            {# Afficher les messages Flash pendant 5 secondes #}
            {% for messageType, flashMessages in app.session.flashbag.all() %}
                {% for flashMessage in flashMessages %}
                    <div class="alert alert-{{ messageType }} flash-message shadow" style="width: fit-content; padding: 8px 16px; margin: 8px;">
                        {{ flashMessage }}
                    </div>
                {% endfor %}
            {% endfor %}

            <div class="container m-0">
                <div class="row listes">
                    <div class="col panel shadow">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="fs-5">Salles</div>
                            <div>
                                <a href="{{ path('app_admin_add_room') }}" class="btn btn-custom-success"><i class="fa-solid fa-plus"></i> Ajouter</a>
                            </div>
                        </div>

                        {# Filtre modal et form #}
                        <ul class="mt-3">
                            {{ form_start(form) }}
                            <div class="d-flex">
                                    {{ form_widget(form.SearchRoom, {'attr': {'class': 'form-control', 'placeholder': 'Rechercher...'}}) }}
                                    <button type="button" class="btn btn-custom-success ml-1" data-bs-toggle="modal" data-bs-target="#FilterModal"><i class="fa-solid fa-filter"></i></button>
                            </div>
                            <div class="ModalDiv">
                                <div class="modal fade ChangeRoomModal" id="FilterModal" tabindex="-1" aria-labelledby="FilterModal" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-body">
                                                <h2>Filtres</h2>

                                                <div class="my-4">
                                                    <label for="floor" class="form-label">{{ form_label(form.Floor) }}</label>
                                                    {{ form_widget(form.Floor, {'attr': {'class': 'form-control'}}) }}
                                                </div>

                                                <div class="form-check my-4">
                                                    {{ form_widget(form.isAssigned, {'attr': {'class': 'form-check-input'}}) }}
                                                    <input type="checkbox" name="is-assigned" value={{ field_value(form.isAssigned) }} class="form-check-input">
                                                    <label for="is-assigned" class="form-check-label">Système d'acquisition attribué</label>
                                                </div>

                                                <div class="my-4">
                                                    <label for="search" class="form-label">{{ form_label(form.SearchAS) }}</label>
                                                    {{ form_widget(form.SearchAS, {'attr': {'class': 'form-control'}}) }}
                                                </div>
                                                {{ form_label(form.Valid) }}
                                                {{ form_widget(form.Valid, {'attr' : { 'class' : 'btn btn-custom-success'  }}) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{ form_end(form) }}

                            <!-- Boucle pour afficher chaque salle -->
                            {% for room in rooms %}
                                {% if room.name|slice(0,searchR|length) == searchR or searchR == null or searchR is empty%}
                                    {% if room.floor == floor or floor == null or floor is empty%}
                                        {% if (assigned == 1 and room.getAcquisitionSystem() != null) or assigned == 0%}
                                            {% if (room.getAcquisitionSystem() is not empty and room.getAcquisitionSystem().getName() == searchAS) or searchAS == null or searchAS is empty%}
                                                <a href="{{ path('app_admin_room', {'id': room.id}) }}" class="text-decoration-none">
                                                    <li class="d-flex justify-content-between
                                                    {% if room.acquisitionSystem %}
                                                        {% if room.acquisitionSystem.isInstalled %}
                                                            {{ room.acquisitionSystem.temperature > 21 ? 'red-border' }}
                                                            {{ room.acquisitionSystem.temperature < 17 ? 'red-border' }}
                                                            {{ room.acquisitionSystem.co2 > 1500 ? 'red-border' }}
                                                            {{ room.acquisitionSystem.humidity > 70 ? 'red-border' }}
                                                        {% endif %}
                                                    {% endif %}
                                                    ">
                                                        <span  style="color:black;">
                                                            {{ room.name }}
                                                        </span>

                                                        <span>
                                                        {% if room.getAcquisitionSystem() is not null %}
                                                            <!-- Afficher le nom du système d'acquisition associé -->
                                                            ({{ room.getAcquisitionSystem().name }})
                                                        {% else %}
                                                            (Aucun système d'acquisition associé)
                                                        {% endif %}
                                                        </span>
                                                    </li>
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="col panel shadow">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="fs-5">Systemes d'aquisition</div>
                            <div>
                                <a href="{{ path('app_admin_add_acquisition_system', {'error': '0'}) }}" class="btn btn-custom-success"><i class="fa-solid fa-plus"></i> Ajouter</a>
                            </div>
                        </div>

                        <ul class="mt-3">
                            <!-- Boucle pour afficher chaque système d'acquisition -->
                            {% for acquisitionSystem in acquisitionSystems %}
                                <a href="{{ path('app_admin_edit_acquisition_system', {id: acquisitionSystem.id}) }}">
                                    <li class="acquisition-system d-flex justify-content-between align-items-center">
                                        <span>{{ acquisitionSystem.name }}</span>

                                        {% if acquisitionSystem.getRoom() is null %}
                                            <!-- Afficher "Non associé" si tel est le cas -->
                                            <div class="alert alert-warning m-0 px-2 p-1">
                                                <i class="fa-solid fa-triangle-exclamation"></i>
                                                (Non associé)
                                            </div>
                                        {% endif %}
                                    </li>
                                </a>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ asset('js/flashMessageHandler.js') }}"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

{% endblock %}